<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Anonymous Voting</title>
</head>
<body>
  <h1>Anonymous Voting</h1>

  <div id="poll"></div>
  <div id="results"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      onSnapshot,
      setDoc
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAFke1UF4RkI-Y7HXX7x0I5gfPnls9Bod8",
      authDomain: "anonymous-voting-72546.firebaseapp.com",
      projectId: "anonymous-voting-72546",
      storageBucket: "anonymous-voting-72546.firebasestorage.app",
      messagingSenderId: "122187938085",
      appId: "1:122187938085:web:3851149bbb70950a1dc2cc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const pollRef = doc(db, "polls", "main");

    async function createPollIfNotExists() {
      const docSnap = await getDoc(pollRef);
      if (!docSnap.exists()) {
        await setDoc(pollRef, {
          question: "Which teacher do you like the most?",
          options: ["Iwahashi", "Consolati", "Cao"],
          votes: [0, 0, 0]
        });
      }
    }

    async function vote(index) {
      const docSnap = await getDoc(pollRef);
      const data = docSnap.data();
      data.votes[index] += 1;
      await updateDoc(pollRef, { votes: data.votes });
    }

    function render(data) {
      const pollDiv = document.getElementById("poll");
      const resultsDiv = document.getElementById("results");

      pollDiv.innerHTML = `<h2>${data.question}</h2>`;
      data.options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.innerText = opt;
        btn.onclick = () => vote(i);
        pollDiv.appendChild(btn);
        pollDiv.appendChild(document.createElement("br"));
      });

      resultsDiv.innerHTML = "<h3>Results</h3>";
      data.options.forEach((opt, i) => {
        resultsDiv.innerHTML += `${opt}: ${data.votes[i]} votes<br>`;
      });
    }

    await createPollIfNotExists();

    onSnapshot(pollRef, (docSnap) => {
      if (docSnap.exists()) {
        render(docSnap.data());
      }
    });
  </script>
</body>
</html>

